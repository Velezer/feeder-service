name: AI Code Agent

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  ai-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set Mode (create or refine)
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "mode=create" >> "$GITHUB_OUTPUT"
            echo "branch=ai-issue-${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            if [[ "${{ github.event.issue.pull_request }}" != "" ]]; then
              echo "mode=refine" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            if [[ "${{ github.event.review.state }}" == "changes_requested" ]]; then
              echo "mode=refine" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Stop if not AI-related
        if: steps.mode.outputs.skip == 'true'
        run: exit 0

      - name: Checkout PR branch
        if: steps.mode.outputs.mode == 'refine'
        run: |
          git fetch origin
          git checkout "${{ github.event.pull_request.head.ref }}"

      - name: Start context-service compressor
        run: |
          git clone --depth 1 https://github.com/Velezer/context-service context-service
          nohup cargo run --manifest-path context-service/Cargo.toml > context-service.log 2>&1 &

          for _ in {1..30}; do
            if curl -fsS "http://127.0.0.1:8080/context" >/dev/null 2>&1; then
              exit 0
            fi
            sleep 1
          done

          echo "context-service failed to start"
          cat context-service.log || true
          exit 1

      - name: Build compressed repository context
        run: |
          mkdir -p context

          if [[ "${{ steps.mode.outputs.mode }}" == "create" ]]; then
            TASK_TEXT="${{ github.event.issue.title }} ${{ github.event.issue.body }}"
          else
            TASK_TEXT="${{ github.event.comment.body }} ${{ github.event.review.body }}"
          fi

          KEYWORDS=$(echo "$TASK_TEXT" | tr '[:upper:]' '[:lower:]' | \
            grep -oE '\b[a-z]{4,}\b' | sort | uniq | head -n 20)

          : > context/file_scores.txt

          find . -type f \( \
            -name "*.rs" -o \
            -name "*.go" -o \
            -name "*.kt" -o \
            -name "*.kts" -o \
            -name "*.md" -o \
            -name "*.yml" -o \
            -name "*.yaml" \
          \) -not -path "./.git/*" \
            -not -path "./target/*" \
            -not -path "./build/*" \
            -not -path "./node_modules/*" \
            -not -path "./context-service/*" \
          | while read -r file; do
              SCORE=0
              for word in $KEYWORDS; do
                COUNT=$(grep -oi "$word" "$file" 2>/dev/null | wc -l)
                SCORE=$((SCORE + COUNT))
              done

              if [[ $SCORE -gt 0 ]]; then
                echo "$SCORE $file" >> context/file_scores.txt
              fi
            done

          SORTED=$(sort -nr context/file_scores.txt | head -n 10)
          if [[ -z "$SORTED" ]]; then
            SORTED=$(find . -type f \( -name "*.rs" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" \) \
              -not -path "./.git/*" -not -path "./target/*" -not -path "./context-service/*" \
              | head -n 5 | awk '{print "1 "$0}')
          fi

          while read -r score file; do
            [ -z "$file" ] && continue
            jq -n --arg p "$file" --arg c "$(head -n 300 "$file")" \
              '{path: $p, content: $c}'
          done <<< "$SORTED" | jq -s '.' > context/selected_files.json

          jq -n \
            --arg context "$TASK_TEXT" \
            --argjson files "$(cat context/selected_files.json)" \
            --argjson max_tokens 1800 \
            '{context: $context, files: $files, max_tokens: $max_tokens}' > context/compress_request.json

          curl -fsS "http://127.0.0.1:8080/context/compress" \
            -H 'Content-Type: application/json' \
            -d @context/compress_request.json > context/compress_response.json

          jq -r '.compressed_context' context/compress_response.json > context/files.txt
          truncate -s 7000 context/files.txt

      - name: Call Local LLM
        env:
          LM_URL: ${{ secrets.LMSTUDIO_URL }}
          LM_KEY: ${{ secrets.LMSTUDIO_API_KEY }}
        run: |
          if [[ "${{ steps.mode.outputs.mode }}" == "create" ]]; then
            TASK="${{ github.event.issue.title }}

            ${{ github.event.issue.body }}"
          else
            TASK="Refine the PR based on this feedback:

            ${{ github.event.comment.body || github.event.review.body }}"
          fi

          FULL_PROMPT="Return STRICT JSON only.
          No markdown.
          No explanation.
          No text before or after JSON.

          Task:
          $TASK

          Repository Summary:
          $(cat context/files.txt)

          Format:
          {
            \"MODIFIED_FILES\": {\"path/to/file.rs\": \"full new file content\"},
            \"PR_TITLE\": \"title\",
            \"PR_BODY\": \"body\"
          }"

          RESPONSE=$(curl -s "$LM_URL/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $LM_KEY" \
            -d "$(jq -n \
              --arg prompt "$FULL_PROMPT" \
              '{
                model: "local-model",
                temperature: 0.1,
                messages: [
                  { role: "user", content: $prompt }
                ]
              }'
            )"
          )

          echo "$RESPONSE" > raw_response.json

          CONTENT=$(jq -r '
            if .choices[0].message.content then
              .choices[0].message.content
            elif .choices[0].text then
              .choices[0].text
            else
              empty
            end
          ' raw_response.json)

          if [ -z "$CONTENT" ]; then
            echo "Model returned empty content"
            exit 1
          fi

          CLEANED=$(printf "%s" "$CONTENT" | tr -d '\000')
          JSON_ONLY=$(echo "$CLEANED" | sed -n '/{/,/}/p')

          echo "$JSON_ONLY" > parsed.json

          echo "=== PARSED JSON ==="
          cat parsed.json

          jq empty parsed.json || {
            echo "Invalid JSON from model"
            exit 1
          }

      - name: Apply file updates
        run: |
          if [[ "${{ steps.mode.outputs.mode }}" == "create" ]]; then
            git checkout -b ai-issue-${{ github.event.issue.number }}
          fi

          FILES=$(jq -r '.MODIFIED_FILES | keys[]' parsed.json)

          for file in $FILES; do
            mkdir -p "$(dirname "$file")"
            jq -r --arg f "$file" '.MODIFIED_FILES[$f]' parsed.json > "$file"
          done

          git config user.name "AI Agent"
          git config user.email "actions@github.com"

          git add .

          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "AI update"
          git push --set-upstream origin "$(git branch --show-current)"

      - name: Create Pull Request
        if: steps.mode.outputs.mode == 'create'
        run: |
          PR_TITLE=$(jq -r '.PR_TITLE' parsed.json)
          PR_BODY=$(jq -r '.PR_BODY' parsed.json)

          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --head "ai-issue-${{ github.event.issue.number }}" \
            --base "${{ github.event.repository.default_branch }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
